<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Persian-likeness Rating Task</title>

    <!-- jsPsych core + CSS -->
    <script src="https://unpkg.com/jspsych@8.2.3"></script>
    <link href="https://unpkg.com/jspsych@8.2.3/css/jspsych.css" rel="stylesheet" />

    <!-- Plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@2.1.1"></script>
  </head>

  <body></body>

  <script>
    // ---------------------------------
    // 1) Initialize (IMPORTANT: set use_webaudio HERE)
    // ---------------------------------
    const jsPsych = initJsPsych({
      // Use HTML5 audio (replay/ended behavior is more predictable across browsers)
      use_webaudio: false, // :contentReference[oaicite:1]{index=1}

      on_finish: () => {
        // Debug view: shows data at the end in the browser
        jsPsych.data.displayData();
      }
    });

    const timeline = [];

    // ---------------------------------
    // 2) Instructions pages (3 pages)
    // ---------------------------------
    timeline.push({
      type: jsPsychInstructions,
      pages: [
        `
          <h2>Introduction</h2>
          <p>You will hear a series of made-up Persian words, one at a time. These words do not exist in Persian.</p>
          <p>Your task is to rate each word how Persian-like it is: how much it sounds like a normal Persian word that you simply never learned before.</p>
          <p>There are no right or wrong answers. We want your honest opinion.</p>
        `,
        `
          <h2>What you will do</h2>
          <p>There is a mini test task that helps you learn how to do the task before you move to the main task.</p>
          <p>Focus on how the word sounds. Using the five labeled slider below, you will rate each word from <b>1</b> to <b>5</b>:</p>
          <p><b>5</b>: perfectly good, normal-sounding Persian word<br>
             <b>1</b>: awful or impossible-sounding Persian word</p>
          <p>After you‚Äôve rated the word, press <b>Next</b> to continue.</p>
        `,
        `
          <h2>Things to keep in mind</h2>
          <p>Focus on how Persian-like each word is, not whether it actually exists.</p>
          <p>We monitor responses to make sure you are attentive, so there will be simple attention checks along the way.</p>
        `
      ],
      show_clickable_nav: true,
      button_label_next: "Next",
      button_label_previous: "Back"
    });

    // ---------------------------------
    // 3) Start practice page
    // ---------------------------------
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Practice</h2>
        <p>You will first complete a short practice block to get familiar with the task.</p>
        <p>Please use headphones if possible.</p>
      `,
      choices: ["Start practice"]
    });

    // ---------------------------------
    // 4) Stimuli lists (EDIT THESE FILENAMES)
    // Put your .wav files in: ./audio/
    // ---------------------------------
    const practiceStimuli = [
      { id: "practice_001", audio: "audio/practice_001.wav" },
      { id: "practice_002", audio: "audio/practice_002.wav" },
      { id: "practice_003", audio: "audio/practice_003.wav" },
      { id: "practice_004", audio: "audio/practice_004.wav" },
      { id: "practice_005", audio: "audio/practice_005.wav" }
    ];

    const mainStimuli = [
      { id: "main_001", audio: "audio/main_001.wav" },
      { id: "main_002", audio: "audio/main_002.wav" },
      { id: "main_003", audio: "audio/main_003.wav" }
      // ... add more main trials here
    ];

    // ---------------------------------
    // 5) Helper: build ONE audio+slider trial + Replay button
    // Robust clearing of "Playing..." using ended + timer fallback
    // ---------------------------------
    function makeRatingTrial(s, phaseLabel) {
      let player = null;
      let durationMs = null;
      let clearTimer = null;

      return {
        type: jsPsychAudioSliderResponse,
        stimulus: s.audio, // auto-plays at trial start

        min: 1,
        max: 5,
        step: 1,
        labels: ["1", "2", "3", "4", "5"],

        response_allowed_while_playing: false,
        require_movement: true,
        button_label: "Next",

        prompt: `
          <div style="margin-top: 12px; margin-bottom: 10px;">
            <button id="replay-btn" type="button">Replay üîÅ</button>
            <span id="replay-status" style="margin-left: 10px; font-size: 0.95em;"></span>
          </div>

          <p><b>How Persian-like does this word sound?</b></p>
          <p>1 = impossible, 5 = perfectly normal</p>
        `,

        on_load: () => {
          const replayBtn = document.getElementById("replay-btn");
          const statusEl = document.getElementById("replay-status");

          const setStatus = (txt) => {
            if (statusEl) statusEl.textContent = txt || "";
          };

          const clearStatus = () => setStatus("");

          // (A) Get jsPsych AudioPlayer for replay/stop/play (official API) :contentReference[oaicite:2]{index=2}
          jsPsych.pluginAPI.getAudioPlayer(s.audio).then((p) => {
            player = p;

            // Best-case: clear when ended fires
            player.addEventListener("ended", () => {
              if (clearTimer) clearTimeout(clearTimer);
              clearStatus();
            });
          });

          // (B) Timer fallback: load duration via HTMLAudio metadata
          // This makes "Playing..." clear even if "ended" event is flaky.
          const metaAudio = new Audio(s.audio);
          metaAudio.addEventListener("loadedmetadata", () => {
            if (isFinite(metaAudio.duration)) {
              durationMs = Math.max(0, Math.round(metaAudio.duration * 1000));
            }
          });
          // Trigger metadata load
          metaAudio.load();

          replayBtn.addEventListener("click", () => {
            if (!player) return;

            // Clear any prior timer, show status
            if (clearTimer) clearTimeout(clearTimer);
            setStatus("Playing...");

            // Restart from beginning
            try {
              player.stop();
              player.play();
            } catch (e) {
              console.warn("Replay failed:", e);
              clearStatus();
              return;
            }

            // Timer fallback to clear status after duration
            // (Add a little padding so it clears after the sound)
            if (durationMs != null) {
              clearTimer = setTimeout(() => {
                clearStatus();
              }, durationMs + 150);
            }
          });
        },

        data: {
          task: "rating",
          phase: phaseLabel,
          trial_id: s.id,
          audio_file: s.audio
        }
      };
    }

    // ---------------------------------
    // 6) Practice block (5 trials)
    // ---------------------------------
    practiceStimuli.forEach((s) => {
      timeline.push(makeRatingTrial(s, "practice"));
    });

    // ---------------------------------
    // 7) Transition page to main task
    // ---------------------------------
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Main task</h2>
        <p>Practice is finished. Press the button below to start the main task.</p>
      `,
      choices: ["Start main task"]
    });

    // ---------------------------------
    // 8) Main task block (randomized order)
    // ---------------------------------
    jsPsych.randomization.shuffle(mainStimuli).forEach((s) => {
      timeline.push(makeRatingTrial(s, "main"));
    });

    // ---------------------------------
    // 9) End page
    // ---------------------------------
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Finished</h2>
        <p>Thank you! You have completed the task.</p>
      `,
      choices: ["Finish"]
    });

    // ---------------------------------
    // 10) Run
    // ---------------------------------
    jsPsych.run(timeline);
  </script>
</html>
