<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Persian-likeness Rating Task</title>

    <!-- jsPsych core + CSS -->
    <script src="https://unpkg.com/jspsych@8.2.3"></script>
    <link href="https://unpkg.com/jspsych@8.2.3/css/jspsych.css" rel="stylesheet" />

    <!-- Plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-slider-response@2.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
  </head>

  <body></body>

  <script>
    // ---------------------------------
    // Helper: download a text file in the browser
    // ---------------------------------
    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    // Participant info
    let participantName = "participant";

    // ---------------------------------
    // Initialize
    // ---------------------------------
    const jsPsych = initJsPsych({
      use_webaudio: false,
      on_finish: () => {
        const rating = jsPsych.data.get().filter({ task: "rating" });

        const header = ["name", "phase", "trial_id", "audio_file", "response", "rt"].join("\t");
        const rows = rating.values().map(d => [
          participantName,
          d.phase,
          d.trial_id,
          d.audio_file,
          d.response,
          d.rt
        ].join("\t"));

        const textOut = [header, ...rows].join("\n");

        const safeName = (participantName || "participant")
          .trim()
          .replace(/[\\/:*?"<>|]+/g, "_")
          .replace(/\s+/g, "_");

        downloadTextFile(`${safeName}.txt`, textOut);

        // Optional debug
        jsPsych.data.displayData();
      }
    });

    const timeline = [];

    // ---------------------------------
    // Welcome flow with Next/Back:
    // 0) Thank you
    // 1) Participant information (ALL required fields must be filled)
    // 2..4) Instruction pages
    // ---------------------------------
    timeline.push({
      type: jsPsychInstructions,
      pages: [
        `
          <h2>Thank you for participating!</h2>
          <p>In this study, you will listen to a series of made-up Persian words and rate how Persian-like they sound.</p>
          <p>Please use headphones if possible and complete the task in a quiet environment.</p>
          <p>Click <b>Next</b> to continue.</p>
        `,
        `
          <h2>Participant information</h2>
          <p>Please answer all questions below. You must fill in every field to continue.</p>

          <div style="margin-top:12px;">
            <label for="participant_name"><b>Participant name:</b></label><br/>
            <input
              id="participant_name"
              type="text"
              placeholder="Type your name..."
              data-required="true"
              data-label="Participant name"
              style="font-size:16px; padding:8px; width:min(420px, 90%); margin-top:6px;"
            />
          </div>

          <!--
            Add more participant questions here later.
            IMPORTANT: For each required field, add:
              data-required="true"
              data-label="Your field label"
            Example:
              <input id="age" type="number" data-required="true" data-label="Age" />
              <select id="gender" data-required="true" data-label="Gender"><option value="">Select...</option>...</select>
          -->

          <div id="pi_error"
               style="color:#b00020; margin-top:12px; display:none;">
          </div>

          <p style="margin-top:16px;">Click <b>Next</b> to continue.</p>
        `,
        `
          <h2>Introduction</h2>
          <p>You will hear a series of made-up Persian words, one at a time. These words do not exist in Persian.</p>
          <p>Your task is to rate each word how Persian-like it is: how much it sounds like a normal Persian word that you simply never learned before.</p>
          <p>There are no right or wrong answers. We want your honest opinion.</p>
        `,
        `
          <h2>What you will do</h2>
          <p>There is a mini test task that helps you learn how to do the task before you move to the main task.</p>
          <p>Focus on how the word sounds. Using the five labeled slider below, you will rate each word from <b>1</b> to <b>5</b>:</p>
          <p><b>5</b>: perfectly good, normal-sounding Persian word<br>
             <b>1</b>: awful or impossible-sounding Persian word</p>
          <p>After you‚Äôve rated the word, press <b>Next</b> to continue.</p>
        `,
        `
          <h2>Things to keep in mind</h2>
          <p>Focus on how Persian-like each word is, not whether it actually exists.</p>
          <p>We monitor responses to make sure you are attentive, so there will be simple attention checks along the way.</p>
        `
      ],
      show_clickable_nav: true,
      allow_backward: true,
      button_label_next: "Next",
      button_label_previous: "Back",

      // Validate participant info page (page index 1) before allowing Next
      on_load: () => {
        const nextBtn = document.querySelector("#jspsych-instructions-next");
        if (!nextBtn) return;

        nextBtn.addEventListener(
          "click",
          (e) => {
            const container = document.querySelector(".jspsych-instructions");
            const pageIndex = container ? Number(container.getAttribute("data-current-page")) : null;

            // Participant info page is index 1
            if (pageIndex === 1) {
              const err = document.getElementById("pi_error");
              const requiredFields = Array.from(
                document.querySelectorAll('[data-required="true"]')
              );

              const missing = [];

              for (const el of requiredFields) {
                const label = el.getAttribute("data-label") || el.id || "This field";

                // Handle different input types
                if (el.tagName === "SELECT") {
                  if (!el.value || el.value.trim() === "") missing.push(label);
                } else if (el.type === "checkbox" || el.type === "radio") {
                  // For radios/checkboxes, require at least one checked in the group (by name)
                  const name = el.name || el.id;
                  if (name) {
                    const group = document.querySelectorAll(`input[name="${name}"]`);
                    if (group.length > 0) {
                      const anyChecked = Array.from(group).some(x => x.checked);
                      if (!anyChecked) missing.push(label);
                    } else {
                      if (!el.checked) missing.push(label);
                    }
                  } else {
                    if (!el.checked) missing.push(label);
                  }
                } else {
                  // text/number/textarea/etc.
                  const v = (el.value ?? "").toString().trim();
                  if (v === "") missing.push(label);
                }
              }

              if (missing.length > 0) {
                // Block page advance
                e.stopImmediatePropagation();
                e.preventDefault();

                if (err) {
                  err.style.display = "block";
                  err.innerHTML =
                    `<b>Please complete all required fields:</b><br/>` +
                    missing.map(m => `‚Ä¢ ${m}`).join("<br/>");
                }

                // Focus first missing field (best effort)
                const firstMissingEl = requiredFields.find(el => {
                  if (el.tagName === "SELECT") return !el.value;
                  const v = (el.value ?? "").toString().trim();
                  return v === "";
                });
                if (firstMissingEl) firstMissingEl.focus();

                return;
              } else {
                if (err) err.style.display = "none";
              }
            }
          },
          true
        );
      },

      // Save participant info when leaving the instructions block
      on_finish: () => {
        const nameInput = document.getElementById("participant_name");
        const val = (nameInput?.value || "").trim();
        participantName = val || "participant";
        jsPsych.data.addProperties({ participant_name: participantName });
      }
    });

    // ---------------------------------
    // Start practice page
    // ---------------------------------
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Practice</h2>
        <p>You will first complete a short practice block to get familiar with the task.</p>
        <p>Please use headphones if possible.</p>
      `,
      choices: ["Start practice"]
    });

    // ---------------------------------
    // Stimuli lists (EDIT THESE FILENAMES)
    // ---------------------------------
    const practiceStimuli = [
      { id: "practice_001", audio: "audio/practice_001.wav" },
      { id: "practice_002", audio: "audio/practice_002.wav" },
      { id: "practice_003", audio: "audio/practice_003.wav" },
      { id: "practice_004", audio: "audio/practice_004.wav" },
      { id: "practice_005", audio: "audio/practice_005.wav" }
    ];

    const mainStimuli = [
      { id: "main_001", audio: "audio/main_001.wav" },
      { id: "main_002", audio: "audio/main_002.wav" },
      { id: "main_003", audio: "audio/main_003.wav" }
      // ... add more main trials here
    ];

    // ---------------------------------
    // Helper: build ONE audio+slider trial + Replay button
    // ---------------------------------
    function makeRatingTrial(s, phaseLabel) {
      let player = null;
      let durationMs = null;
      let clearTimer = null;

      return {
        type: jsPsychAudioSliderResponse,
        stimulus: s.audio,

        min: 1,
        max: 5,
        step: 1,
        labels: ["1", "2", "3", "4", "5"],

        response_allowed_while_playing: false,
        require_movement: true,
        button_label: "Next",

        prompt: `
          <div style="margin-top: 12px; margin-bottom: 10px;">
            <button id="replay-btn" type="button">Replay üîÅ</button>
            <span id="replay-status" style="margin-left: 10px; font-size: 0.95em;"></span>
          </div>

          <p><b>How Persian-like does this word sound?</b></p>
          <p>1 = impossible, 5 = perfectly normal</p>
        `,

        on_load: () => {
          const replayBtn = document.getElementById("replay-btn");
          const statusEl = document.getElementById("replay-status");

          const setStatus = (txt) => {
            if (statusEl) statusEl.textContent = txt || "";
          };

          jsPsych.pluginAPI.getAudioPlayer(s.audio).then((p) => {
            player = p;
            player.addEventListener("ended", () => {
              if (clearTimer) clearTimeout(clearTimer);
              setStatus("");
            });
          });

          const metaAudio = new Audio(s.audio);
          metaAudio.addEventListener("loadedmetadata", () => {
            if (isFinite(metaAudio.duration)) {
              durationMs = Math.max(0, Math.round(metaAudio.duration * 1000));
            }
          });
          metaAudio.load();

          replayBtn.addEventListener("click", () => {
            if (!player) return;

            if (clearTimer) clearTimeout(clearTimer);
            setStatus("Playing...");

            try {
              player.stop();
              player.play();
            } catch (e) {
              console.warn("Replay failed:", e);
              setStatus("");
              return;
            }

            if (durationMs != null) {
              clearTimer = setTimeout(() => setStatus(""), durationMs + 150);
            }
          });
        },

        data: {
          task: "rating",
          phase: phaseLabel,
          trial_id: s.id,
          audio_file: s.audio
        }
      };
    }

    // Practice block (5 trials)
    practiceStimuli.forEach((s) => timeline.push(makeRatingTrial(s, "practice")));

    // Transition to main task
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Main task</h2>
        <p>Practice is finished. Press the button below to start the main task.</p>
      `,
      choices: ["Start main task"]
    });

    // Main block (randomized)
    jsPsych.randomization.shuffle(mainStimuli).forEach((s) => {
      timeline.push(makeRatingTrial(s, "main"));
    });

    // End page
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <h2>Finished</h2>
        <p>Thank you! You have completed the task.</p>
        <p>Your results file will download automatically.</p>
      `,
      choices: ["Finish"]
    });

    jsPsych.run(timeline);
  </script>
</html>
